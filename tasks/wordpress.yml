---
  # OpenResty site configuration

- name: create web service user {{ resty_web_user }}
  user:
    name: "{{ resty_web_user }}"
    system: yes

- name: copy nginx.conf
  template:
    src: nginx.conf
    dest: /usr/local/openresty/nginx/conf/nginx.conf

- name: make log directory
  file:
    path: /var/log/openresty/
    state: directory

- name: make sites directory
  file:
    path: /usr/local/openresty/nginx/sites
    state: directory

#- name: copy default.conf
#  template:
#    src: default.conf
#    dest: /usr/local/openresty/nginx/sites/default.conf

#- name: Copy nginx configuration for wordpress
#  template:
#    src: wp.conf
#    dest: /usr/local/openresty/nginx/sites/default.conf

- name: make directory for default site
  file:
    path: /usr/local/openresty/nginx/html/default
    state: directory

- name: upload / generate ssl certs
  import_tasks: ssl.yml

- name: copy index.html as STUB
  template:
    src: index.html
    dest: /usr/local/openresty/nginx/html/default/

- name: copy info.php as STUB
  template:
    src: info.php
    dest: /usr/local/openresty/nginx/html/default/

- name: Copy nginx cloudflare configuration
  template:
    src: cloudflare.conf
    dest: /usr/local/openresty/nginx/conf/cloudflare.conf

- name: Copy ssl configuration
  template:
    src: ssl.conf
    dest: /usr/local/openresty/nginx/conf/ssl.conf

- name: Install python-passlib to use htpasswd module
  yum:
    name: python-passlib
    state: present

- name: Generate password file for wp-admin directory
  htpasswd:
    path: /usr/local/openresty/nginx/sites/.htpasswd
    name: "{{ htpasswd_user }}"
    password: "{{ htpasswd_pass }}"
    crypt_scheme: md5_crypt

- name: Copy nginx configuration for wordpress
  template:
    src: wp.conf
    dest: /usr/local/openresty/nginx/sites/default.conf

- name: insert firewalld rule for nginx port {{ nginx_port }}
  firewalld:
    port: "{{ nginx_port }}/tcp"
    permanent: true
    state: enabled
    immediate: yes
  ignore_errors: yes
  when: firewalld_installed == true

- name: Enable OpenResty
  service:
    name: openresty
    state: started
    enabled: yes
  ignore_errors: yes
  notify: restart openresty
